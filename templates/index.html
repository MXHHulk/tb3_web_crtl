<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>TB3 Pro æ§åˆ¶ä¸­å¿ƒ</title>
    <script src="{{ url_for('static', filename='js/eventemitter2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/easeljs.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/roslib.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ros2d.min.js') }}"></script>

    <style>
        /* æ¢å¾©ä¹‹å‰çš„ç¶“å…¸æš—é»‘é¢¨æ ¼ */
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; padding: 20px; }
        #map { width: 600px; height: 400px; background: #333; margin: 10px auto; border-radius: 10px; border: 2px solid #444; }
        
        .btn-panel { background: #2a2a2a; padding: 15px; border-radius: 15px; display: inline-block; margin: 10px; border: 1px solid #444; }
        .mode-btn { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; transition: 0.2s; }
        
        /* ç‹€æ…‹å„€è¡¨æ¿ */
        .dashboard { margin: 10px 0; color: #ffc107; font-family: monospace; font-size: 1.2em; }

        /* WASD 3x3 çŸ©é™£æ’ç‰ˆ */
        .teleop-grid { display: grid; grid-template-columns: repeat(3, 80px); grid-template-rows: repeat(3, 80px); gap: 10px; justify-content: center; margin: 20px auto; }
        .btn-wasd { width: 80px; height: 80px; background: #444; color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; user-select: none; transition: 0.1s; }
        .btn-wasd:active { background: #666; transform: scale(0.95); }
        .btn-stop { background: #dc3545; color: white; }
        .btn-stop:hover { background: #ff4d5a; }
        .btn-dir { border: 1px solid #555; }
        .btn-dir:hover { border-color: #007bff; }
    </style>
</head>
<body>
    <h1>TB3 è‡ªå‹•å»ºåœ–æ§åˆ¶ä¸­å¿ƒ</h1>
    <div id="status" style="color: #ffc107; margin-bottom: 10px;">ğŸ”´ ç­‰å¾… ROS é€£ç·š...</div>
    
    <div class="dashboard">
        LINEAR: <span id="lin-val">0.00</span> m/s | 
        ANGULAR: <span id="ang-val">0.00</span> rad/s
    </div>

    <div id="map"></div>

    <div class="btn-panel">
        <h3>æ¨¡å¼åˆ‡æ›</h3>
        <button class="mode-btn" style="background: #007bff; color: white;" onclick="callApi('/start_slam')">ğŸš€ å•Ÿå‹•å»ºåœ–</button>
        <button class="mode-btn" style="background: #28a745; color: white;" onclick="callApi('/start_explore')">ğŸ¤– è‡ªå‹•æ¢ç´¢</button>
        <button class="mode-btn" style="background: #dc3545; color: white;" onclick="emergencyStop()">ğŸ›‘ åœæ­¢ä»»å‹™</button>
        <br>
        <button class="mode-btn" style="background: #17a2b8; color: white;" onclick="window.location.href='/download_map'">ğŸ’¾ ä¸‹è¼‰åœ°åœ–</button>
        <button class="mode-btn" style="background: #6c757d; color: white;" onclick="resetSystem()">ğŸ§¹ é‡ç½®ç³»çµ±</button>
    </div>

    <div class="teleop-grid">
        <div></div>
        <button class="btn-wasd btn-dir" onclick="changeSpeed(0.02, 0)">W</button>
        <div></div>
        
        <button class="btn-wasd btn-dir" onclick="changeSpeed(0, 0.2)">A</button>
        <button class="btn-wasd btn-stop" onclick="emergencyStop()">STOP</button>
        <button class="btn-wasd btn-dir" onclick="changeSpeed(0, -0.2)">D</button>
        
        <div></div>
        <button class="btn-wasd btn-dir" onclick="changeSpeed(-0.02, 0)">X</button>
        <div></div>
    </div>

    <script>
        var ros = new ROSLIB.Ros({ url : 'ws://' + window.location.hostname + ':9090' });

        var targetLinear = 0.0;
        var targetAngular = 0.0;
        var heartbeatTimer = null;
        const LIMIT_LIN = 0.22;
        const LIMIT_ANG = 2.84;

        ros.on('connection', () => {
            document.getElementById('status').innerText = "ğŸŸ¢ å·²é€£ç·šè‡³ ROS (å·¡èˆªæ¨¡å¼)";
            document.getElementById('status').style.color = "#28a745";
            startHeartbeat();
        });

        // åœ°åœ–æ¸²æŸ“
        var viewer = new ROS2D.Viewer({ divID : 'map', width : 600, height : 400 });
        var gridClient = new ROS2D.OccupancyGridClient({
            ros : ros, rootObject : viewer.scene, continuous: true
        });

        gridClient.on('change', () => {
            viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
        });

        var cmdVel = new ROSLIB.Topic({ ros: ros, name: '/cmd_vel', messageType: 'geometry_msgs/Twist' });

        // å¿ƒè·³æ©Ÿåˆ¶ï¼šæ¯ 100ms æŒçºŒç™¼é€æŒ‡ä»¤
        function startHeartbeat() {
            if (heartbeatTimer) clearInterval(heartbeatTimer);
            heartbeatTimer = setInterval(() => {
                sendCmd();
            }, 100);
        }

        function changeSpeed(linStep, angStep) {
            targetLinear = Math.min(Math.max(targetLinear + linStep, -LIMIT_LIN), LIMIT_LIN);
            targetAngular = Math.min(Math.max(targetAngular + angStep, -LIMIT_ANG), LIMIT_ANG);
            targetLinear = parseFloat(targetLinear.toFixed(2));
            targetAngular = parseFloat(targetAngular.toFixed(2));
            updateDisplay();
        }

        function emergencyStop() {
            targetLinear = 0.0;
            targetAngular = 0.0;
            updateDisplay();
            sendCmd(); 
        }

        function sendCmd() {
            var twist = new ROSLIB.Message({
                linear: { x: targetLinear, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: targetAngular }
            });
            cmdVel.publish(twist);
        }

        function updateDisplay() {
            document.getElementById('lin-val').innerText = targetLinear.toFixed(2);
            document.getElementById('ang-val').innerText = targetAngular.toFixed(2);
        }

        // éµç›¤ç©ºç™½éµæ€¥åœ
        window.addEventListener('keydown', (e) => {
            if (e.code === "Space") {
                e.preventDefault();
                emergencyStop();
            }
        });

        function callApi(url) { fetch(url).then(res => res.json()); }
        
        function resetSystem() {
            if(confirm("ç¢ºå®šè¦æ¸…ç†ç’°å¢ƒä¸¦é‡ç½® TB3 å—ï¼Ÿ")) {
                callApi('/reset_system');
                setTimeout(() => { location.reload(); }, 5000);
            }
        }
    </script>
</body>
</html>
