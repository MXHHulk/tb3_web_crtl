<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>TB3 ç®¡ç†ç³»çµ±</title>
    <script src="{{ url_for('static', filename='js/eventemitter2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/easeljs.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/roslib.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ros2d.min.js') }}"></script>

    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; margin: 0; padding: 20px; }
        #map { width: 600px; height: 400px; background: #333; margin: 10px auto; border-radius: 10px; border: 2px solid #444; }
        .btn-panel { background: #2a2a2a; padding: 15px; border-radius: 15px; display: inline-block; margin: 10px; }
        .mode-btn { padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; }
        
        /* WASD 3x3 çŸ©é™£ */
        .teleop-grid { display: grid; grid-template-columns: repeat(3, 70px); grid-template-rows: repeat(3, 70px); gap: 10px; justify-content: center; margin: 15px auto; }
        .btn-wasd { width: 70px; height: 70px; background: #444; color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; user-select: none; }
        .btn-wasd:active { background: #ffc107; color: black; }
        .btn-stop { background: #dc3545; }
    </style>
</head>
<body>
    <h1>TB3 è‡ªå‹•å»ºåœ–æ§åˆ¶ä¸­å¿ƒ</h1>
    <div id="status" style="color: #ffc107; margin-bottom: 10px;">ğŸ”´ ç­‰å¾… ROS é€£ç·š...</div>
    
    <div id="map"></div>

    <div class="btn-panel">
        <h3>æ¨¡å¼åˆ‡æ›</h3>
        <button class="mode-btn" style="background: #007bff; color: white;" onclick="callApi('/start_slam')">ğŸš€ å•Ÿå‹•å»ºåœ–</button>
        <button class="mode-btn" style="background: #28a745; color: white;" onclick="callApi('/start_explore')">ğŸ¤– è‡ªå‹•æ¢ç´¢</button>
        <button class="mode-btn" style="background: #dc3545; color: white;" onclick="callApi('/stop_all')">ğŸ›‘ åœæ­¢ä»»å‹™</button>
        <br>
        <button class="mode-btn" style="background: #17a2b8; color: white;" onclick="downloadMap()">ğŸ’¾ ä¸‹è¼‰åœ°åœ–</button>
        <button class="mode-btn" style="background: #6c757d; color: white;" onclick="resetSystem()">ğŸ§¹ é‡ç½®ç³»çµ±</button>
    </div>

    <div class="teleop-grid">
        <div></div>
        <button class="btn-wasd" onmousedown="move(0.2, 0)" onmouseup="stop()" ontouchstart="move(0.2, 0)" ontouchend="stop()">W</button>
        <div></div>
        <button class="btn-wasd" onmousedown="move(0, 1)" onmouseup="stop()" ontouchstart="move(0, 1)" ontouchend="stop()">A</button>
        <button class="btn-wasd btn-stop" onclick="stop()">S</button>
        <button class="btn-wasd" onmousedown="move(0, -1)" onmouseup="stop()" ontouchstart="move(0, -1)" ontouchend="stop()">D</button>
        <div></div>
        <button class="btn-wasd" onmousedown="move(-0.2, 0)" onmouseup="stop()" ontouchstart="move(-0.2, 0)" ontouchend="stop()">X</button>
        <div></div>
    </div>

    <script>
        var ros = new ROSLIB.Ros({ url : 'ws://' + window.location.hostname + ':9090' });

        ros.on('connection', () => {
            document.getElementById('status').innerText = "ğŸŸ¢ å·²é€£ç·šè‡³ ROS";
            document.getElementById('status').style.color = "#28a745";
        });

        var viewer = new ROS2D.Viewer({ divID : 'map', width : 600, height : 400 });
        var gridClient = new ROS2D.OccupancyGridClient({
            ros : ros, rootObject : viewer.scene, continuous: true, compression: 'png'
        });

        gridClient.on('change', () => {
            viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
            viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
        });

        var cmdVel = new ROSLIB.Topic({ ros: ros, name: '/cmd_vel', messageType: 'geometry_msgs/Twist' });

        function move(l, a) {
            var t = new ROSLIB.Message({ linear: {x:l, y:0, z:0}, angular: {x:0, y:0, z:a} });
            cmdVel.publish(t);
        }
        function stop() { move(0,0); }
        function callApi(url) { fetch(url).then(res => res.json()).then(d => alert(d.status)); }
        function downloadMap() { window.location.href = '/download_map'; }
        function resetSystem() {
            if(confirm("ç¢ºå®šè¦æ¸…ç†ç’°å¢ƒä¸¦é‡ç½® TB3 å—ï¼Ÿ")) {
                callApi('/reset_system');
                setTimeout(() => { location.reload(); }, 5000);
            }
        }
    </script>
</body>
</html>
